ALTER TABLE "broadcast_views" DROP CONSTRAINT "broadcast_views_broadcast_publication_broadcasts_id_fk";
--> statement-breakpoint
ALTER TABLE "broadcast_views" ADD COLUMN "publication" bigint;--> statement-breakpoint
ALTER TABLE "publication_broadcasts" ADD COLUMN "publication" bigint;--> statement-breakpoint
ALTER TABLE "broadcast_views" ADD CONSTRAINT "broadcast_views_publication_campaign_publications_id_fk" FOREIGN KEY ("publication") REFERENCES "public"."campaign_publications"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "broadcast_views" ADD CONSTRAINT "broadcast_views_broadcast_publication_broadcasts_id_fk" FOREIGN KEY ("broadcast") REFERENCES "public"."publication_broadcasts"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "publication_broadcasts" ADD CONSTRAINT "publication_broadcasts_publication_campaign_publications_id_fk" FOREIGN KEY ("publication") REFERENCES "public"."campaign_publications"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE VIEW "public"."vw_campaign_publications" AS (select count("publication_broadcasts"."id") as "broadcast_count", count("broadcast_views"."id") as "click_count", sum("wallet_transactions"."value") as "total_exhausted_credits", "credit_allocations"."allocated", "campaign_publications"."creditAllocation", "campaign_publications"."campaign", "campaign_publications"."updatedAt", "campaign_publications"."id", "campaign_publications"."createdAt" from "campaign_publications" left join "campaigns" on "campaigns"."id" = "campaign_publications"."campaign" left join "publication_broadcasts" on "publication_broadcasts"."publication" = "campaign_publications"."id" left join "broadcast_views" on "broadcast_views"."publication" = "campaign_publications"."id" left join "credit_allocations" on "credit_allocations"."id" = "campaign_publications"."creditAllocation" left join "wallet_transactions" on ("wallet_transactions"."creditAllocation" = "campaign_publications"."creditAllocation" and "wallet_transactions"."status" = 'complete' and "wallet_transactions"."type" = 'reward') group by "credit_allocations"."allocated", "credit_allocations"."id", "campaign_publications"."id");